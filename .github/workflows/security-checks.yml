# ZoneWise Desktop — Security Checks CI
# Runs on every push/PR to main: dependency audit, security test suite, secret scanning.

name: Security Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  security-audit:
    name: Security Audit & Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Dependency audit
        run: |
          echo "=== Checking for known vulnerabilities ==="
          # bun doesn't have a built-in audit command, so we check package versions
          # against known advisories via npm audit on the lockfile
          npx npm-audit-resolver --json || true
        continue-on-error: true

      - name: Run security tests
        run: bun test tests/security/

      - name: Scan for hardcoded secrets
        run: |
          echo "=== Scanning for potential secrets in source ==="
          # Check for common secret patterns in source files
          FINDINGS=$(grep -rn --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" \
            -E "(sk-ant-|sk-[a-zA-Z0-9]{48}|ghp_[a-zA-Z0-9]{36}|sbp_[a-zA-Z0-9]{40})" \
            apps/ packages/ || true)
          if [ -n "$FINDINGS" ]; then
            echo "::warning::Potential secrets found in source files:"
            echo "$FINDINGS"
            exit 1
          fi
          echo "No hardcoded secrets detected."

      - name: Verify .gitignore excludes sensitive files
        run: |
          if ! grep -q '\.env' .gitignore; then
            echo "::error::.gitignore must exclude .env files"
            exit 1
          fi
          if ! grep -q 'node_modules' .gitignore; then
            echo "::error::.gitignore must exclude node_modules"
            exit 1
          fi
          echo ".gitignore properly configured."

      - name: Check for .env files in repo
        run: |
          ENV_FILES=$(find . -name ".env" -o -name ".env.local" -o -name ".env.production" | grep -v node_modules || true)
          if [ -n "$ENV_FILES" ]; then
            echo "::error::Found .env files committed to repo: $ENV_FILES"
            exit 1
          fi
          echo "No .env files found in repository."

      - name: Verify security controls exist
        run: |
          echo "=== Verifying security controls ==="
          # SEC-003: Filesystem whitelist
          grep -q "validateFilePath" apps/electron/src/main/ipc.ts && echo "✓ SEC-003: validateFilePath exists" || echo "::error::SEC-003: validateFilePath missing"
          grep -q "sensitivePatterns" apps/electron/src/main/ipc.ts && echo "✓ SEC-003: sensitivePatterns exists" || echo "::error::SEC-003: sensitivePatterns missing"
          # SEC-006: AES-256-GCM encryption
          grep -q "aes-256-gcm" apps/electron/src/main/lib/secure-store.ts && echo "✓ SEC-006: AES-256-GCM exists" || echo "::error::SEC-006: AES-256-GCM missing"
          # SEC-007: Shell whitelist
          grep -q "ALLOWED_SHELLS" apps/electron/src/main/shell-env.ts && echo "✓ SEC-007: ALLOWED_SHELLS exists" || echo "::error::SEC-007: ALLOWED_SHELLS missing"
          grep -q "getSafeShell" apps/electron/src/main/shell-env.ts && echo "✓ SEC-007: getSafeShell exists" || echo "::error::SEC-007: getSafeShell missing"
          # SEC-010: Input validation
          grep -q "ALLOWED_ATTACHMENT_EXTENSIONS" apps/electron/src/main/ipc.ts && echo "✓ SEC-010: Extension whitelist exists" || echo "::error::SEC-010: Extension whitelist missing"
          grep -q "sanitizeFilename" apps/electron/src/main/ipc.ts && echo "✓ SEC-010: sanitizeFilename exists" || echo "::error::SEC-010: sanitizeFilename missing"
