# Upstream Sync + Release Docs + Cross-Repo Notify
# Syncs lukilabs/craft-agents-oss â†’ breverdbidder/zonewise-desktop
# Then notifies zonewise-web that upstream changed
# Schedule: every 6 hours + manual trigger

name: Sync Upstream Craft Agents

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if already current'
        required: false
        default: 'false'

permissions:
  contents: write

env:
  UPSTREAM_REPO: lukilabs/craft-agents-oss

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      synced: ${{ steps.sync.outputs.synced }}
      upstream_tag: ${{ steps.detect.outputs.upstream_tag }}
      behind_count: ${{ steps.detect.outputs.behind_count }}
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Configure Git
        run: |
          git config user.name "ZoneWise Sync Bot"
          git config user.email "sync@zonewise.ai"

      - name: Add Upstream Remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git 2>/dev/null || true
          git fetch upstream --tags

      - name: Detect Upstream Status
        id: detect
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/main 2>/dev/null || echo "0")
          UPSTREAM_TAG=$(curl -s "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest" | jq -r '.tag_name // "unknown"')

          echo "behind_count=$BEHIND" >> $GITHUB_OUTPUT
          echo "upstream_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT

          echo "Upstream tag: $UPSTREAM_TAG"
          echo "Commits behind: $BEHIND"

      - name: Sync Upstream
        id: sync
        run: |
          BEHIND=${{ steps.detect.outputs.behind_count }}

          if [ "$BEHIND" = "0" ] && [ "${{ github.event.inputs.force_sync }}" != "true" ]; then
            echo "Already in sync. Skipping."
            echo "synced=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Syncing $BEHIND commits from upstream..."
          git checkout main

          if git merge upstream/main --no-edit -m "sync: upstream ${{ steps.detect.outputs.upstream_tag }}"; then
            git push origin main
            echo "synced=true" >> $GITHUB_OUTPUT
            echo "Sync complete."
          else
            echo "Merge conflict. Auto-resolving..."
            git checkout --ours apps/viewer/src/App.tsx apps/viewer/src/index.css 2>/dev/null || true
            git checkout --theirs packages/ apps/electron/ 2>/dev/null || true
            git add -A
            git commit --no-edit -m "sync: upstream ${{ steps.detect.outputs.upstream_tag }} (auto-resolved)" || true
            git push origin main
            echo "synced=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Vercel Deploy
        if: steps.sync.outputs.synced == 'true'
        run: |
          if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
            curl -s -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
          fi
          echo "Vercel auto-deploys on push anyway."

      - name: Summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Upstream: ${{ steps.detect.outputs.upstream_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- Behind: ${{ steps.detect.outputs.behind_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Synced: ${{ steps.sync.outputs.synced }}" >> $GITHUB_STEP_SUMMARY

  release-doc:
    needs: sync
    if: needs.sync.outputs.synced == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GH_PAT }}

      - name: Configure Git
        run: |
          git config user.name "ZoneWise Sync Bot"
          git config user.email "sync@zonewise.ai"

      - name: Fetch Release Notes
        id: notes
        run: |
          UPSTREAM_TAG="${{ needs.sync.outputs.upstream_tag }}"
          DATE=$(date -u +%Y-%m-%d)
          VERSION="${UPSTREAM_TAG#v}"
          ZW_VERSION="2.${VERSION#0.}"

          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "zw_version=$ZW_VERSION" >> $GITHUB_OUTPUT

          # Save release body to file (avoids heredoc issues)
          curl -s "https://api.github.com/repos/lukilabs/craft-agents-oss/releases/latest" | jq -r '.body // "No release notes"' > /tmp/upstream_notes.txt

      - name: Generate Release Doc
        run: |
          mkdir -p docs/releases
          DATE="${{ steps.notes.outputs.date }}"
          ZW_VERSION="${{ steps.notes.outputs.zw_version }}"
          UPSTREAM_TAG="${{ needs.sync.outputs.upstream_tag }}"

          cat > "docs/releases/ZONEWISE_V${ZW_VERSION}_RELEASE_${DATE}.md" << EOF
          # ZoneWise V${ZW_VERSION} Release Notes
          **Date:** ${DATE}
          **Upstream:** Craft Agents OSS ${UPSTREAM_TAG}
          **Status:** Synced & Deployed

          ## Upstream Changes
          $(cat /tmp/upstream_notes.txt)

          ## ZoneWise Integration
          - Web: zonewise.ai/app (proxy to viewer)
          - Desktop: GitHub Releases
          - Backend: zonewise-agents.onrender.com

          *Auto-generated by ZoneWise Sync Bot*
          EOF

          git add docs/releases/
          git commit -m "release: ZoneWise V${ZW_VERSION} (upstream ${UPSTREAM_TAG})" || echo "No changes"
          git push origin main || echo "Push skipped"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ZW_TAG="v${{ steps.notes.outputs.zw_version }}"

          # Check if release already exists
          EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            "https://api.github.com/repos/breverdbidder/zonewise-desktop/releases/tags/${ZW_TAG}")

          if [ "$EXISTS" = "200" ]; then
            echo "Release ${ZW_TAG} already exists. Skipping."
            exit 0
          fi

          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/breverdbidder/zonewise-desktop/releases" \
            -d "{
              \"tag_name\": \"${ZW_TAG}\",
              \"name\": \"ZoneWise ${ZW_TAG} (Craft Agents ${{ needs.sync.outputs.upstream_tag }})\",
              \"body\": \"Upstream sync with Craft Agents ${{ needs.sync.outputs.upstream_tag }}.\nSee docs/releases/ for full notes.\",
              \"draft\": false,
              \"prerelease\": false
            }"

  notify-web:
    needs: [sync, release-doc]
    if: needs.sync.outputs.synced == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Notify zonewise-web
        run: |
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/breverdbidder/zonewise-web/dispatches" \
            -d "{
              \"event_type\": \"upstream-synced\",
              \"client_payload\": {
                \"upstream_tag\": \"${{ needs.sync.outputs.upstream_tag }}\",
                \"synced_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }
            }"
          echo "Notified zonewise-web of upstream sync."

      - name: Log to Supabase
        if: always()
        run: |
          if [ -n "${{ secrets.SUPABASE_URL }}" ] && [ -n "${{ secrets.SUPABASE_SERVICE_KEY }}" ]; then
            curl -s -X POST \
              "${{ secrets.SUPABASE_URL }}/rest/v1/insights" \
              -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
              -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"type\": \"upstream_sync\",
                \"data\": {
                  \"upstream_tag\": \"${{ needs.sync.outputs.upstream_tag }}\",
                  \"behind_count\": ${{ needs.sync.outputs.behind_count }},
                  \"synced\": true,
                  \"notified_web\": true,
                  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                }
              }" > /dev/null 2>&1
          fi
