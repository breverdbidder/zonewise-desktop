<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZoneWise.AI â€” Florida Zoning Intelligence</title>
  <meta name="description" content="AI-powered zoning intelligence across all 67 Florida counties. Chat in any language.">
  <meta name="theme-color" content="#1E3A5F">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{colors:{navy:'#1E3A5F','navy-dark':'#162D4A',amber:'#F59E0B'},fontFamily:{sans:['"Inter"','system-ui','sans-serif'],hebrew:['"Heebo"','"Inter"','sans-serif'],mono:['"JetBrains Mono"','monospace']}}}}</script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{overflow:hidden;background:#0f172a;color:#e2e8f0;font-family:'Inter',system-ui,sans-serif}
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}
    .msg-enter{animation:fadeUp .3s ease-out}
    [dir="rtl"]{font-family:'Heebo','Inter',system-ui,sans-serif}
    ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
    .thinking-dot{animation:pulse-dot 1.4s infinite}
    .thinking-dot:nth-child(2){animation-delay:.2s}
    .thinking-dot:nth-child(3){animation-delay:.4s}
  </style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const{useState,useRef,useEffect,useCallback,useMemo}=React;
const API="https://zonewise-agents.onrender.com";
const MAPBOX="pk.eyJ1IjoiZXZlcmVzdDE4IiwiYSI6ImNtanB5cDQ5ZzF1eWgzaHB2cGVhZXdqbjMifQ.4RPrkTf84GL1-clmhmCnTw";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const uid=()=>`${Date.now()}-${Math.random().toString(36).slice(2,7)}`;
const store={
  getSessions(){try{return JSON.parse(localStorage.getItem('zw_sessions')||'[]')}catch{return[]}},
  saveSessions(s){localStorage.setItem('zw_sessions',JSON.stringify(s))},
  getMessages(id){try{return JSON.parse(localStorage.getItem(`zw_msg_${id}`)||'[]')}catch{return[]}},
  saveMessages(id,m){localStorage.setItem(`zw_msg_${id}`,JSON.stringify(m))},
  deleteMessages(id){localStorage.removeItem(`zw_msg_${id}`)},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LANGUAGE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANGS={
  en:{flag:"ğŸ‡ºğŸ‡¸",name:"English",dir:"ltr"},
  he:{flag:"ğŸ‡®ğŸ‡±",name:"×¢×‘×¨×™×ª",dir:"rtl"},
  es:{flag:"ğŸ‡ªğŸ‡¸",name:"EspaÃ±ol",dir:"ltr"},
  pt:{flag:"ğŸ‡§ğŸ‡·",name:"PortuguÃªs",dir:"ltr"},
  fr:{flag:"ğŸ‡«ğŸ‡·",name:"FranÃ§ais",dir:"ltr"},
  ar:{flag:"ğŸ‡¸ğŸ‡¦",name:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",dir:"rtl"},
  ht:{flag:"ğŸ‡­ğŸ‡¹",name:"KreyÃ²l",dir:"ltr"},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ICONS (inline SVG)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Icon=({d,size=16,className=""})=>(
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>
);
const icons={
  plus:"M12 5v14M5 12h14",
  send:"M22 2L11 13M22 2l-7 20-4-9-9-4z",
  map:"M1 6v16l7-4 8 4 7-4V2l-7 4-8-4z",
  building:"M3 21h18M5 21V7l8-4v18M19 21V11l-6-4",
  chart:"M18 20V10M12 20V4M6 20v-6",
  x:"M18 6L6 18M6 6l12 12",
  menu:"M3 12h18M3 6h18M3 18h18",
  chevL:"M15 18l-6-6 6-6",
  chevR:"M9 18l6-6-6 6",
  search:"M11 17.25a6.25 6.25 0 110-12.5 6.25 6.25 0 010 12.5zM16 16l4.5 4.5",
  trash:"M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2",
  sparkle:"M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.91-1.01z",
  file:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z M14 2v6h6",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Sidebar({sessions,activeId,onSelect,onNew,onDelete,collapsed,onToggle}){
  const[search,setSearch]=useState('');
  const filtered=sessions.filter(s=>!search||s.title.toLowerCase().includes(search.toLowerCase()));

  if(collapsed) return(
    <div className="w-12 bg-slate-900 border-r border-slate-700/50 flex flex-col items-center py-3 gap-2">
      <button onClick={onToggle} className="p-2 rounded-lg hover:bg-slate-800 text-slate-400"><Icon d={icons.chevR}/></button>
      <button onClick={onNew} className="p-2 rounded-lg hover:bg-slate-800 text-slate-400"><Icon d={icons.plus}/></button>
    </div>
  );

  return(
    <div className="w-64 bg-slate-900 border-r border-slate-700/50 flex flex-col">
      <div className="p-3 border-b border-slate-700/50">
        <div className="flex items-center justify-between mb-2">
          <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider">Sessions</span>
          <div className="flex gap-1">
            <button onClick={onNew} className="p-1.5 rounded-md hover:bg-slate-800 text-slate-400" title="New chat"><Icon d={icons.plus} size={14}/></button>
            <button onClick={onToggle} className="p-1.5 rounded-md hover:bg-slate-800 text-slate-400"><Icon d={icons.chevL} size={14}/></button>
          </div>
        </div>
        <div className="relative">
          <Icon d={icons.search} size={14} className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500"/>
          <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search..." className="w-full pl-7 pr-2 py-1.5 text-xs rounded-md bg-slate-800 border border-slate-700 text-slate-200 placeholder:text-slate-500 focus:outline-none focus:border-amber"/>
        </div>
      </div>
      <div className="flex-1 overflow-y-auto p-2 space-y-0.5">
        {filtered.length===0?(
          <p className="text-center text-xs text-slate-500 py-8">{search?'No matches':'No sessions yet'}</p>
        ):filtered.map(s=>(
          <div key={s.id} onClick={()=>onSelect(s.id)}
            className={`group relative px-3 py-2 rounded-lg cursor-pointer transition-colors ${s.id===activeId?'bg-slate-800 text-white':'text-slate-300 hover:bg-slate-800/50'}`}>
            <div className="text-sm font-medium truncate pr-6">{s.title}</div>
            {s.preview&&<div className="text-[11px] text-slate-500 truncate mt-0.5">{s.preview}</div>}
            <div className="text-[10px] text-slate-600 mt-0.5">{new Date(s.updatedAt).toLocaleDateString()}</div>
            <button onClick={e=>{e.stopPropagation();onDelete(s.id)}} className="absolute right-2 top-2 p-1 rounded opacity-0 group-hover:opacity-100 hover:bg-red-500/20 text-slate-500 hover:text-red-400 transition-all">
              <Icon d={icons.trash} size={12}/>
            </button>
          </div>
        ))}
      </div>
      <div className="p-3 border-t border-slate-700/50 text-center">
        <span className="text-[10px] text-slate-600">ZoneWise.AI Â· 67 FL Counties</span>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RIGHT PANEL (Map / Stats / 3D / Export tabs)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function RightPanel({visible,onClose,panelData}){
  const[tab,setTab]=useState('map');
  const[stats,setStats]=useState(null);

  useEffect(()=>{
    if(tab==='stats') fetch(`${API}/api/stats`).then(r=>r.json()).then(setStats).catch(()=>{});
  },[tab]);

  if(!visible) return null;

  const tabs=[
    {id:'map',icon:icons.map,label:'Map'},
    {id:'stats',icon:icons.chart,label:'Stats'},
    {id:'3d',icon:icons.building,label:'3D'},
    {id:'export',icon:icons.file,label:'Export'},
  ];

  const mapLat=panelData?.lat||28.39;
  const mapLng=panelData?.lng||-80.61;
  const mapUrl=`https://api.mapbox.com/styles/v1/mapbox/dark-v11/static/${mapLng},${mapLat},10,0/500x400@2x?access_token=${MAPBOX}`;

  return(
    <div className="w-80 xl:w-96 bg-slate-900 border-l border-slate-700/50 flex flex-col">
      <div className="flex border-b border-slate-700/50">
        {tabs.map(t=>(
          <button key={t.id} onClick={()=>setTab(t.id)}
            className={`flex-1 flex items-center justify-center gap-1.5 px-2 py-2.5 text-[11px] font-medium border-b-2 transition-colors ${tab===t.id?'border-amber text-amber':'border-transparent text-slate-500 hover:text-slate-300'}`}>
            <Icon d={t.icon} size={14}/>{t.label}
          </button>
        ))}
        <button onClick={onClose} className="px-2 text-slate-500 hover:text-slate-300"><Icon d={icons.x} size={14}/></button>
      </div>

      <div className="flex-1 overflow-y-auto p-4">
        {tab==='map'&&(
          <div className="space-y-3">
            <div className="rounded-lg overflow-hidden border border-slate-700/50">
              <img src={mapUrl} alt="Map" className="w-full h-48 object-cover" loading="lazy"/>
            </div>
            <div className="bg-slate-800/50 rounded-lg p-3 text-xs text-slate-400">
              <p className="font-medium text-slate-200 mb-1">ğŸ“ {panelData?.jurisdiction||'Brevard County, FL'}</p>
              <p>{mapLat.toFixed(4)}, {mapLng.toFixed(4)}</p>
            </div>
            <p className="text-[10px] text-slate-600 text-center">Interactive Mapbox coming next sprint</p>
          </div>
        )}

        {tab==='stats'&&(
          <div className="space-y-3">
            <h3 className="text-sm font-semibold text-slate-200">Platform Data</h3>
            {stats?(
              <div className="grid grid-cols-2 gap-2">
                {Object.entries(stats).map(([k,v])=>(
                  <div key={k} className="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p className="text-lg font-bold text-amber">{typeof v==='number'?v.toLocaleString():String(v)}</p>
                    <p className="text-[10px] text-slate-500 uppercase tracking-wider">{k.replace(/_/g,' ')}</p>
                  </div>
                ))}
              </div>
            ):<p className="text-xs text-slate-500 animate-pulse">Loading stats...</p>}
          </div>
        )}

        {tab==='3d'&&(
          <div className="flex flex-col items-center justify-center h-64 gap-4">
            <div className="w-32 h-32 bg-navy/30 border-2 border-navy/60 rounded-xl flex items-center justify-center" style={{transform:'perspective(300px) rotateX(15deg) rotateY(-20deg)'}}>
              <Icon d={icons.building} size={40} className="text-navy/40"/>
            </div>
            {panelData?.setbacks?(
              <div className="text-center text-sm">
                <p>Front: <b>{panelData.setbacks.front||'â€”'}</b>â€² Â· Side: <b>{panelData.setbacks.side||'â€”'}</b>â€² Â· Rear: <b>{panelData.setbacks.rear||'â€”'}</b>â€²</p>
                {panelData.maxHeight&&<p className="text-slate-400">Max Height: <b className="text-amber">{panelData.maxHeight} ft</b></p>}
              </div>
            ):<p className="text-xs text-slate-500">Ask about setbacks to generate 3D envelope</p>}
          </div>
        )}

        {tab==='export'&&(
          <div className="flex flex-col items-center justify-center h-64 gap-4 text-center">
            <Icon d={icons.file} size={40} className="text-slate-600"/>
            <div>
              <p className="text-sm font-medium text-slate-200">Export Reports</p>
              <p className="text-xs text-slate-500 mt-1 max-w-xs">Ask the AI to "create a full report" for any property to generate analysis</p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THINKING DOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ThinkingDots({text}){
  return(
    <div className="flex gap-3 msg-enter">
      <div className="w-7 h-7 rounded-full bg-amber/10 flex items-center justify-center shrink-0 mt-0.5">
        <Icon d={icons.sparkle} size={14} className="text-amber"/>
      </div>
      <div className="bg-slate-800 rounded-xl px-4 py-2.5 flex items-center gap-2">
        <span className="text-xs text-slate-400">{text||'Thinking'}</span>
        <span className="flex gap-0.5">
          <span className="w-1.5 h-1.5 bg-amber rounded-full thinking-dot"/>
          <span className="w-1.5 h-1.5 bg-amber rounded-full thinking-dot"/>
          <span className="w-1.5 h-1.5 bg-amber rounded-full thinking-dot"/>
        </span>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT CENTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STARTERS=[
  {emoji:'ğŸ ',text:'What can I build at 625 Ocean St, Satellite Beach?'},
  {emoji:'ğŸ“Š',text:'Show me all zoning districts in Brevard County'},
  {emoji:'ğŸ“‹',text:'Create a full report for Palm Bay R-1 zone'},
  {emoji:'ğŸ”',text:'Compare setbacks: R-1 vs R-2 in Melbourne'},
];

function ChatCenter({messages,onSend,isLoading,thinkText,session,lang,onLangChange}){
  const[input,setInput]=useState('');
  const scrollRef=useRef(null);
  const inputRef=useRef(null);
  const dir=LANGS[lang]?.dir||'ltr';

  useEffect(()=>{
    if(scrollRef.current) scrollRef.current.scrollTop=scrollRef.current.scrollHeight;
  },[messages,isLoading]);

  const send=(text)=>{
    const msg=(text||input).trim();
    if(!msg||isLoading) return;
    setInput('');
    onSend(msg);
    inputRef.current?.focus();
  };

  const display=messages.filter(m=>m.role!=='system');

  return(
    <div className="flex-1 flex flex-col min-w-0" dir={dir}>
      {/* Header */}
      <div className="px-4 py-2.5 border-b border-slate-700/50 flex items-center justify-between bg-slate-900/80 backdrop-blur">
        <div className="flex items-center gap-2">
          <div className="w-7 h-7 rounded-lg bg-navy flex items-center justify-center">
            <span className="text-white text-xs font-bold">Z</span>
          </div>
          <div>
            <h1 className="text-sm font-semibold text-white">{session?.title||'ZoneWise AI'}</h1>
            <p className="text-[10px] text-slate-500">67 Counties Â· Real-Time Data Â· Multilingual</p>
          </div>
        </div>
        <div className="flex items-center gap-1">
          {Object.entries(LANGS).map(([code,{flag}])=>(
            <button key={code} onClick={()=>onLangChange(code)}
              className={`px-1.5 py-0.5 text-xs rounded transition-colors ${lang===code?'bg-amber text-navy-dark font-medium':'text-slate-500 hover:text-slate-300 hover:bg-slate-800'}`}>
              {flag}
            </button>
          ))}
          <span className="ml-2 inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-400 text-[10px]">
            <span className="w-1.5 h-1.5 rounded-full bg-emerald-500"/>Live
          </span>
        </div>
      </div>

      {/* Messages or Empty State */}
      {display.length===0&&!isLoading?(
        <div className="flex-1 flex flex-col items-center justify-center gap-8 px-4">
          <div className="text-center">
            <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-navy/20 mb-4">
              <Icon d={icons.sparkle} size={32} className="text-amber"/>
            </div>
            <h2 className="text-xl font-semibold text-white mb-2">ZoneWise AI</h2>
            <p className="text-sm text-slate-400 max-w-md">Florida's zoning intelligence platform. Ask about any property, zoning district, setbacks, or permitted uses across all 67 counties.</p>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-lg w-full">
            {STARTERS.map((s,i)=>(
              <button key={i} onClick={()=>send(s.text)}
                className="text-left px-4 py-3 rounded-xl border border-slate-700/50 bg-slate-800/30 hover:bg-slate-800 transition-colors text-sm text-slate-300">
                <span className="mr-1">{s.emoji}</span>{s.text}
              </button>
            ))}
          </div>
        </div>
      ):(
        <div ref={scrollRef} className="flex-1 overflow-y-auto px-4 py-4 space-y-4">
          {display.map((m,i)=>(
            <div key={m.id||i} className={`flex gap-3 msg-enter ${m.role==='user'?'justify-end':'justify-start'}`}>
              {m.role==='assistant'&&(
                <div className="w-7 h-7 rounded-full bg-amber/10 flex items-center justify-center shrink-0 mt-0.5">
                  <Icon d={icons.sparkle} size={14} className="text-amber"/>
                </div>
              )}
              <div className={`max-w-[80%] rounded-xl px-4 py-2.5 text-sm leading-relaxed ${
                m.role==='user'?'bg-navy text-white':'bg-slate-800 text-slate-200 border border-slate-700/30'
              }`}>
                {m.content.split('\n').map((line,j)=>{
                  if(line.startsWith('## ')) return <h3 key={j} className="text-sm font-semibold mt-2 mb-1 text-amber">{line.slice(3)}</h3>;
                  if(line.startsWith('**')&&line.endsWith('**')) return <p key={j} className="font-semibold text-white">{line.slice(2,-2)}</p>;
                  if(line.startsWith('â–¸ ')||line.startsWith('â€¢ ')||line.startsWith('- ')) return <p key={j} className="ml-2 text-slate-300">{line}</p>;
                  if(line.trim()==='') return <br key={j}/>;
                  return <p key={j}>{line}</p>;
                })}
              </div>
            </div>
          ))}
          {isLoading&&<ThinkingDots text={thinkText}/>}
        </div>
      )}

      {/* Input */}
      <div className="p-3 border-t border-slate-700/50 bg-slate-900/80 backdrop-blur">
        <div className="flex gap-2 items-end">
          <textarea ref={inputRef} value={input} onChange={e=>setInput(e.target.value)}
            onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}}}
            placeholder={lang==='he'?'...×©××œ ×¢×œ × ×›×¡, ××–×•×¨, ××• ×”×™×ª×¨ ×‘× ×™×™×”':'Ask about any Florida property, zoning code, or district...'}
            className="flex-1 resize-none min-h-[40px] max-h-32 px-4 py-2.5 rounded-xl bg-slate-800 border border-slate-700 text-sm text-white placeholder:text-slate-500 focus:outline-none focus:border-amber transition-colors"
            rows={1} dir={dir}/>
          <button onClick={()=>send()} disabled={!input.trim()||isLoading}
            className="shrink-0 w-10 h-10 rounded-xl bg-amber hover:bg-amber/90 disabled:bg-slate-700 disabled:text-slate-500 text-navy-dark flex items-center justify-center transition-colors">
            <Icon d={icons.send} size={16}/>
          </button>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App(){
  const[sessions,setSessions]=useState(()=>store.getSessions());
  const[activeId,setActiveId]=useState(()=>sessions[0]?.id||null);
  const[messages,setMessages]=useState([]);
  const[isLoading,setIsLoading]=useState(false);
  const[thinkText,setThinkText]=useState('');
  const[sidebarCollapsed,setSidebarCollapsed]=useState(false);
  const[rightOpen,setRightOpen]=useState(true);
  const[panelData,setPanelData]=useState({});
  const[lang,setLang]=useState('en');
  const[mobileMenu,setMobileMenu]=useState(false);

  // Load messages when session changes
  useEffect(()=>{
    if(activeId) setMessages(store.getMessages(activeId));
    else setMessages([]);
  },[activeId]);

  // Save sessions
  useEffect(()=>{ store.saveSessions(sessions); },[sessions]);

  // Save messages
  useEffect(()=>{
    if(activeId&&messages.length>0) store.saveMessages(activeId,messages);
  },[messages,activeId]);

  const newSession=useCallback(()=>{
    const s={id:uid(),title:'New Chat',createdAt:Date.now(),updatedAt:Date.now(),messageCount:0,preview:''};
    setSessions(prev=>[s,...prev]);
    setActiveId(s.id);
    setMessages([]);
  },[]);

  const deleteSession=useCallback((id)=>{
    setSessions(prev=>prev.filter(s=>s.id!==id));
    store.deleteMessages(id);
    if(activeId===id){
      const remaining=sessions.filter(s=>s.id!==id);
      setActiveId(remaining[0]?.id||null);
    }
  },[activeId,sessions]);

  const sendMessage=useCallback(async(content)=>{
    let sid=activeId;
    if(!sid){
      const s={id:uid(),title:content.slice(0,50),createdAt:Date.now(),updatedAt:Date.now(),messageCount:0,preview:''};
      setSessions(prev=>[s,...prev]);
      setActiveId(s.id);
      sid=s.id;
    }

    const userMsg={id:uid(),sessionId:sid,role:'user',content,timestamp:Date.now()};
    setMessages(prev=>[...prev,userMsg]);
    setIsLoading(true);
    setThinkText('Processing...');

    try{
      const res=await fetch(`${API}/chat/stream`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({query:content}),
      });

      if(!res.ok) throw new Error(`${res.status}`);

      const reader=res.body.getReader();
      const decoder=new TextDecoder();
      let answer='',intent='',buf='';
      const suggestions=[];

      while(true){
        const{done,value}=await reader.read();
        if(done) break;
        buf+=decoder.decode(value,{stream:true});
        const lines=buf.split('\n');
        buf=lines.pop()||'';
        for(const line of lines){
          if(!line.startsWith('data: ')) continue;
          try{
            const p=JSON.parse(line.slice(6));
            if(p.type==='answer') answer=p.value;
            else if(p.type==='intent') intent=p.value;
            else if(p.type==='thinking') setThinkText(p.value);
            else if(p.type==='suggestion') suggestions.push(p.value);
            else if(p.type==='data'&&p.value) setPanelData(prev=>({...prev,...(typeof p.value==='object'?p.value:{})}));
          }catch{}
        }
      }

      const assistantMsg={id:uid(),sessionId:sid,role:'assistant',content:answer||'Sorry, I couldn\'t process that query.',timestamp:Date.now()};
      setMessages(prev=>[...prev,assistantMsg]);

      // Update session
      setSessions(prev=>prev.map(s=>s.id===sid?{...s,
        title:s.messageCount===0?content.slice(0,50)+(content.length>50?'...':''):s.title,
        updatedAt:Date.now(),messageCount:s.messageCount+2,preview:(answer||'').slice(0,80)
      }:s));

    }catch(err){
      console.error('Stream error:',err);
      try{
        const fb=await fetch(`${API}/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:content})});
        const data=await fb.json();
        setMessages(prev=>[...prev,{id:uid(),sessionId:sid,role:'assistant',content:data.answer||'Error processing query.',timestamp:Date.now()}]);
      }catch{
        setMessages(prev=>[...prev,{id:uid(),sessionId:sid,role:'assistant',content:'âš ï¸ Connection error. Backend may be warming up (~30s cold start). Please try again.',timestamp:Date.now()}]);
      }
    }finally{
      setIsLoading(false);
      setThinkText('');
    }
  },[activeId]);

  const activeSession=sessions.find(s=>s.id===activeId)||null;

  return(
    <div className="h-screen flex flex-col">
      {/* Mobile header */}
      <div className="lg:hidden border-b border-slate-700/50 p-3 flex items-center justify-between bg-slate-900">
        <div className="flex items-center gap-2">
          <div className="w-7 h-7 rounded-lg bg-navy flex items-center justify-center">
            <span className="text-white text-xs font-bold">Z</span>
          </div>
          <span className="text-sm font-semibold text-white">ZoneWise AI</span>
        </div>
        <button onClick={()=>setMobileMenu(!mobileMenu)} className="p-2 text-slate-400"><Icon d={icons.menu}/></button>
      </div>

      <div className="flex-1 flex overflow-hidden">
        {/* Desktop sidebar */}
        <div className="hidden lg:block">
          <Sidebar sessions={sessions} activeId={activeId} onSelect={setActiveId}
            onNew={newSession} onDelete={deleteSession}
            collapsed={sidebarCollapsed} onToggle={()=>setSidebarCollapsed(!sidebarCollapsed)}/>
        </div>

        {/* Mobile sidebar overlay */}
        {mobileMenu&&(
          <div className="lg:hidden fixed inset-0 z-50 bg-slate-950/90" onClick={()=>setMobileMenu(false)}>
            <div className="w-72 h-full" onClick={e=>e.stopPropagation()}>
              <Sidebar sessions={sessions} activeId={activeId}
                onSelect={id=>{setActiveId(id);setMobileMenu(false);}}
                onNew={()=>{newSession();setMobileMenu(false);}}
                onDelete={deleteSession} collapsed={false} onToggle={()=>setMobileMenu(false)}/>
            </div>
          </div>
        )}

        {/* Chat center */}
        <ChatCenter messages={messages} onSend={sendMessage} isLoading={isLoading}
          thinkText={thinkText} session={activeSession} lang={lang} onLangChange={setLang}/>

        {/* Desktop right panel */}
        <div className="hidden lg:block">
          <RightPanel visible={rightOpen} onClose={()=>setRightOpen(false)} panelData={panelData}/>
        </div>
      </div>

      {/* Footer stats bar */}
      <div className="border-t border-slate-700/50 px-4 py-1.5 bg-slate-900/80 flex items-center justify-between text-[10px] text-slate-600">
        <span>Powered by Claude Opus 4.6 Â· Data: Supabase</span>
        <span>zonewise.ai</span>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
