<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ZoneWise Map - Brevard County Zoning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; }
    
    .container { display: flex; height: 100vh; }
    
    /* Sidebar */
    .sidebar {
      width: 380px;
      background: white;
      border-right: 1px solid #E5E7EB;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 16px 20px;
      background: #1E3A5F;
      color: white;
    }
    .sidebar-header h1 { font-size: 20px; margin-bottom: 4px; }
    .sidebar-header p { font-size: 13px; opacity: 0.8; }
    
    .controls {
      padding: 12px 16px;
      border-bottom: 1px solid #E5E7EB;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .controls select, .controls input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #D1D5DB;
      border-radius: 6px;
      font-size: 14px;
    }
    .controls button {
      padding: 10px 16px;
      background: #0D9488;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }
    .controls button:hover { background: #0F766E; }
    .controls button:disabled { background: #9CA3AF; cursor: not-allowed; }
    
    .info-panel {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .info-card {
      background: #F9FAFB;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .info-card h3 {
      color: #1E3A5F;
      font-size: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .info-card .zone-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      color: white;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #E5E7EB;
      font-size: 13px;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #6B7280; }
    .info-value { color: #111827; font-weight: 500; }
    
    .loading-overlay {
      position: absolute;
      top: 70px;
      left: 390px;
      background: rgba(255,255,255,0.9);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 100;
      display: none;
    }
    .loading-overlay.show { display: flex; align-items: center; gap: 10px; }
    
    .stats-bar {
      padding: 10px 16px;
      background: #F3F4F6;
      border-top: 1px solid #E5E7EB;
      font-size: 12px;
      color: #6B7280;
    }
    
    /* Legend */
    .legend {
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #E5E7EB;
    }
    .legend-title { font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 13px; }
    .legend-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; }
    .legend-color { width: 16px; height: 12px; border-radius: 2px; }
    
    /* Map */
    #map { flex: 1; }
    
    .mapboxgl-popup-content {
      padding: 12px 16px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>üó∫Ô∏è ZoneWise</h1>
        <p>Brevard County Zoning Polygons</p>
      </div>
      
      <div class="controls">
        <select id="jurisdiction-select">
          <option value="">Fly to Jurisdiction...</option>
          <option value="-80.6081,28.0836,12">Melbourne</option>
          <option value="-80.5887,27.9606,12">Palm Bay</option>
          <option value="-80.5887,28.1472,13">Indian Harbour Beach</option>
          <option value="-80.8076,28.6122,12">Titusville</option>
          <option value="-80.7420,28.3861,12">Cocoa</option>
          <option value="-80.5901,28.1761,13">Satellite Beach</option>
          <option value="-80.6078,28.3200,13">Cocoa Beach</option>
          <option value="-80.7248,28.3169,12">Rockledge</option>
          <option value="-80.6519,28.0722,12">West Melbourne</option>
          <option value="-80.6056,28.4058,13">Cape Canaveral</option>
          <option value="-80.65,28.25,9">All Brevard County</option>
        </select>
        <button id="load-btn" onclick="loadZoning()">üîÑ Load Zoning for View</button>
      </div>
      
      <div class="info-panel" id="info-panel">
        <div class="info-card">
          <h3>üìç Click a Zone on Map</h3>
          <p style="color:#6B7280; font-size:13px;">
            Zoom in and click any colored zoning area to see details.
            <br><br>
            <strong>Data Source:</strong> Brevard County GIS
            <br>
            <strong>Total Polygons:</strong> 10,092
          </p>
        </div>
        <div class="info-card">
          <h3>üéØ Quick Start</h3>
          <ol style="color:#6B7280; font-size:13px; padding-left: 20px; line-height: 1.8;">
            <li>Select a jurisdiction or zoom manually</li>
            <li>Click "Load Zoning for View"</li>
            <li>Click any colored polygon</li>
            <li>View zoning details in sidebar</li>
          </ol>
        </div>
      </div>
      
      <div class="legend">
        <div class="legend-title">Zoning Categories</div>
        <div class="legend-grid">
          <div class="legend-item"><div class="legend-color" style="background:#22C55E"></div> Residential (R, RU, RA)</div>
          <div class="legend-item"><div class="legend-color" style="background:#3B82F6"></div> Commercial (BU, C)</div>
          <div class="legend-item"><div class="legend-color" style="background:#8B5CF6"></div> Industrial (IU, IN)</div>
          <div class="legend-item"><div class="legend-color" style="background:#F59E0B"></div> Agricultural (A, AGR, AU)</div>
          <div class="legend-item"><div class="legend-color" style="background:#EC4899"></div> Planned (PUD, PIP)</div>
          <div class="legend-item"><div class="legend-color" style="background:#6B7280"></div> Other/Special</div>
        </div>
      </div>
      
      <div class="stats-bar" id="stats-bar">
        Polygons loaded: 0 | Zoom: 9
      </div>
    </div>
    
    <!-- Map -->
    <div id="map"></div>
    <div class="loading-overlay" id="loading">
      <div style="width:20px;height:20px;border:3px solid #E5E7EB;border-top-color:#0D9488;border-radius:50%;animation:spin 1s linear infinite;"></div>
      <span>Loading zoning data...</span>
    </div>
  </div>

  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <script>
    // Config
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiZXZlcmVzdDE4IiwiYSI6ImNtanB5cDQ5ZzF1eWgzaHB2cGVhZXdqbjMifQ.4RPrkTf84GL1-clmhmCnTw';
    const GIS_URL = 'https://gis.brevardfl.gov/gissrv/rest/services/Planning_Development/Zoning_WKID2881/MapServer/0/query';
    
    // Zoning color mapping
    function getZoneColor(zoning) {
      if (!zoning) return '#6B7280';
      const z = zoning.toUpperCase();
      // Residential
      if (z.startsWith('R') || z.includes('RU') || z.includes('EU') || z.includes('SR')) return '#22C55E';
      // Commercial
      if (z.startsWith('BU') || z.startsWith('C') || z.includes('COM')) return '#3B82F6';
      // Industrial
      if (z.startsWith('I') || z.includes('IND')) return '#8B5CF6';
      // Agricultural
      if (z.startsWith('A') || z.includes('AGR') || z.includes('FARM')) return '#F59E0B';
      // Planned/PUD
      if (z.includes('PUD') || z.includes('PIP') || z.includes('PA')) return '#EC4899';
      // Government/Public
      if (z.startsWith('G') || z.includes('GML')) return '#14B8A6';
      return '#6B7280';
    }
    
    function getZoneCategory(zoning) {
      if (!zoning) return 'Unknown';
      const z = zoning.toUpperCase();
      if (z.startsWith('R') || z.includes('RU') || z.includes('EU') || z.includes('SR')) return 'Residential';
      if (z.startsWith('BU') || z.startsWith('C') || z.includes('COM')) return 'Commercial';
      if (z.startsWith('I') || z.includes('IND')) return 'Industrial';
      if (z.startsWith('A') || z.includes('AGR') || z.includes('FARM')) return 'Agricultural';
      if (z.includes('PUD') || z.includes('PIP') || z.includes('PA')) return 'Planned Development';
      if (z.startsWith('G') || z.includes('GML')) return 'Government/Mixed';
      return 'Special District';
    }
    
    // Initialize map
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-80.65, 28.25],
      zoom: 9
    });
    
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    map.addControl(new mapboxgl.ScaleControl(), 'bottom-left');
    
    let loadedFeatures = 0;
    
    // Update stats
    function updateStats() {
      document.getElementById('stats-bar').textContent = 
        `Polygons loaded: ${loadedFeatures.toLocaleString()} | Zoom: ${Math.round(map.getZoom())}`;
    }
    
    map.on('zoom', updateStats);
    
    // Load zoning for current view
    async function loadZoning() {
      const btn = document.getElementById('load-btn');
      const loading = document.getElementById('loading');
      
      btn.disabled = true;
      loading.classList.add('show');
      
      try {
        const bounds = map.getBounds();
        const bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
        
        // Query GIS server
        const url = `${GIS_URL}?` + new URLSearchParams({
          where: '1=1',
          geometry: bbox,
          geometryType: 'esriGeometryEnvelope',
          inSR: '4326',
          outSR: '4326',
          outFields: 'ZONING,DENSCAP',
          f: 'geojson',
          resultRecordCount: '2000'
        });
        
        const response = await fetch(url);
        const geojson = await response.json();
        
        // Add colors to features
        geojson.features.forEach(f => {
          f.properties.color = getZoneColor(f.properties.ZONING);
          f.properties.category = getZoneCategory(f.properties.ZONING);
        });
        
        loadedFeatures = geojson.features.length;
        
        // Remove existing layer/source
        if (map.getLayer('zoning-fill')) map.removeLayer('zoning-fill');
        if (map.getLayer('zoning-outline')) map.removeLayer('zoning-outline');
        if (map.getSource('zoning')) map.removeSource('zoning');
        
        // Add source
        map.addSource('zoning', { type: 'geojson', data: geojson });
        
        // Add fill layer
        map.addLayer({
          id: 'zoning-fill',
          type: 'fill',
          source: 'zoning',
          paint: {
            'fill-color': ['get', 'color'],
            'fill-opacity': 0.5
          }
        });
        
        // Add outline layer
        map.addLayer({
          id: 'zoning-outline',
          type: 'line',
          source: 'zoning',
          paint: {
            'line-color': ['get', 'color'],
            'line-width': 1.5,
            'line-opacity': 0.8
          }
        });
        
        updateStats();
        
      } catch (error) {
        console.error('Error loading zoning:', error);
        alert('Error loading zoning data. Check console.');
      } finally {
        btn.disabled = false;
        loading.classList.remove('show');
      }
    }
    
    // Handle click on zoning polygon
    map.on('click', 'zoning-fill', (e) => {
      const props = e.features[0].properties;
      const zoning = props.ZONING || 'Unknown';
      const density = props.DENSCAP || 'N/A';
      const category = props.category;
      const color = props.color;
      
      // Update info panel
      document.getElementById('info-panel').innerHTML = `
        <div class="info-card">
          <h3>
            <span class="zone-badge" style="background:${color}">${zoning}</span>
            ${category}
          </h3>
          <div class="info-row">
            <span class="info-label">Zoning Code</span>
            <span class="info-value">${zoning}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Category</span>
            <span class="info-value">${category}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Density Cap</span>
            <span class="info-value">${density.trim() || 'Not specified'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Location</span>
            <span class="info-value">${e.lngLat.lat.toFixed(5)}, ${e.lngLat.lng.toFixed(5)}</span>
          </div>
        </div>
        <div class="info-card">
          <h3>üìã Zone Details</h3>
          <p style="color:#6B7280; font-size:13px;">
            This parcel is zoned <strong>${zoning}</strong> under Brevard County's 
            ${category.toLowerCase()} zoning classification.
          </p>
          <br>
          <p style="color:#6B7280; font-size:12px;">
            <em>For detailed setbacks and requirements, query the ZoneWise chat interface.</em>
          </p>
        </div>
      `;
      
      // Show popup
      new mapboxgl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(`<strong>${zoning}</strong><br>${category}`)
        .addTo(map);
    });
    
    // Change cursor on hover
    map.on('mouseenter', 'zoning-fill', () => {
      map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'zoning-fill', () => {
      map.getCanvas().style.cursor = '';
    });
    
    // Jurisdiction selector
    document.getElementById('jurisdiction-select').addEventListener('change', function(e) {
      if (!e.target.value) return;
      const [lng, lat, zoom] = e.target.value.split(',').map(Number);
      map.flyTo({ center: [lng, lat], zoom: zoom, duration: 1500 });
    });
    
    // Auto-load when map settles
    map.on('load', () => {
      updateStats();
    });
  </script>
</body>
</html>
